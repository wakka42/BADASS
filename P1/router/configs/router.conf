{{- $peer_tag := "ibgp" -}}
{{- $bgp_as := env.Getenv "BGP_AS" -}}
{{- $bgp_mode := env.Getenv "BGP_MODE" -}}
{{- $bgp_range := env.Getenv "BGP_RANGE" -}}
{{- $bgp_neighbor := env.Getenv "BGP_NEIGHBOR" | strings.Split "," -}}
{{- $ospf_ranges :=  env.Getenv "OSPF_RANGES" | strings.Split "," -}}

{{- if index $ospf_ranges 0 -}}
router ospf
  {{- range $ospf_ranges }}
  network {{ . | strings.TrimSpace }} area 0
  {{- end }}
!
{{- end }}

{{- if and $bgp_mode $bgp_as }}
router bgp {{ $bgp_as }}
  neighbor {{ $peer_tag }} peer-group
  neighbor {{ $peer_tag }} remote-as {{ $bgp_as }}
  neighbor {{ $peer_tag }} update-source lo
  {{- if eq $bgp_mode "leaf" }}
  {{- range $bgp_neighbor }}
  neighbor {{ . | strings.TrimSpace }} peer-group {{ $peer_tag }}
  {{- end }}
  {{- else if eq $bgp_mode "reflector" }}
  bgp listen range {{ $bgp_range }} peer-group {{ $peer_tag }}
  {{- end }}
  !
  address-family l2vpn evpn
    neighbor {{ $peer_tag }} activate
    {{- if eq $bgp_mode "leaf" }}
    advertise-all-vni
    {{- else if eq $bgp_mode "reflector" }}
    neighbor {{ $peer_tag }} route-reflector-client
    {{- end }}
  exit-address-family
  !
!
{{- end }}